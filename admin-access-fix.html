<!DOCTYPE html>
<html>
<head>
    <title>Admin Access Fix - Vercel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .result { margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .loading { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 12px 24px; margin: 8px; cursor: pointer; border: none; border-radius: 5px; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .step { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .step h3 { margin-top: 0; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Admin Access Fix for Vercel</h1>
        <p>This tool will help you get admin access working on your Vercel deployment.</p>
        
        <div class="step">
            <h3>Step 1: Test Database Connection</h3>
            <p>First, let's make sure your Neon database is connected properly.</p>
            <button class="btn-primary" onclick="testDatabase()">Test Database Connection</button>
        </div>

        <div class="step">
            <h3>Step 2: Create Admin Session</h3>
            <p>Create an admin session with the correct email (shyamkaarthikeyan@gmail.com).</p>
            <button class="btn-success" onclick="createAdminSession()">Create Admin Session</button>
        </div>

        <div class="step">
            <h3>Step 3: Test Admin APIs</h3>
            <p>Test all admin analytics endpoints to make sure they work.</p>
            <button class="btn-warning" onclick="testAllAdminAPIs()">Test All Admin APIs</button>
        </div>

        <div class="step">
            <h3>Step 4: Go to Admin Dashboard</h3>
            <p>Once everything is working, go to your admin dashboard.</p>
            <button class="btn-primary" onclick="goToAdmin()">Open Admin Dashboard</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        const results = document.getElementById('results');
        let adminToken = null;
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        function clearResults() {
            results.innerHTML = '';
        }

        async function testDatabase() {
            clearResults();
            addResult('üîç Testing database connection...', 'loading');
            
            try {
                // Test with a simple admin token first
                const response = await fetch('/api/admin/analytics/system', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Token': 'admin_token_vercel_test_123'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult('‚úÖ Database connection successful!', 'success');
                    addResult(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                } else {
                    const errorText = await response.text();
                    addResult(`‚ùå Database connection failed: ${response.status}`, 'error');
                    addResult(`<pre>${errorText}</pre>`, 'error');
                    
                    if (response.status === 401) {
                        addResult('üîë Authentication issue detected. Let\'s create an admin session.', 'info');
                    }
                }
            } catch (error) {
                addResult(`‚ùå Network error: ${error.message}`, 'error');
                addResult('üí° Make sure you\'re accessing this from your Vercel domain, not localhost.', 'info');
            }
        }

        async function createAdminSession() {
            addResult('üîë Creating admin session...', 'loading');
            
            try {
                const response = await fetch('/api/admin/auth/session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'shyamkaarthikeyan@gmail.com',
                        userId: 'admin_user_vercel'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    adminToken = data.adminToken;
                    
                    // Store in localStorage
                    localStorage.setItem('admin-token', adminToken);
                    localStorage.setItem('admin-session', JSON.stringify(data.adminSession));
                    
                    addResult('‚úÖ Admin session created successfully!', 'success');
                    addResult(`üîë Admin token: ${adminToken}`, 'success');
                    addResult('üíæ Token saved to localStorage', 'success');
                    addResult(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                } else {
                    const errorText = await response.text();
                    addResult(`‚ùå Failed to create admin session: ${response.status}`, 'error');
                    addResult(`<pre>${errorText}</pre>`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå Network error: ${error.message}`, 'error');
            }
        }

        async function testAllAdminAPIs() {
            if (!adminToken) {
                adminToken = localStorage.getItem('admin-token');
                if (!adminToken) {
                    addResult('‚ùå No admin token found. Please create an admin session first.', 'error');
                    return;
                }
            }

            addResult('üß™ Testing all admin APIs...', 'loading');
            
            const endpoints = [
                { name: 'Users Analytics', url: '/api/admin/analytics/users' },
                { name: 'Documents Analytics', url: '/api/admin/analytics/documents' },
                { name: 'Downloads Analytics', url: '/api/admin/analytics/downloads' },
                { name: 'System Analytics', url: '/api/admin/analytics/system' }
            ];

            for (const endpoint of endpoints) {
                try {
                    addResult(`Testing ${endpoint.name}...`, 'loading');
                    
                    const response = await fetch(endpoint.url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Admin-Token': adminToken
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        addResult(`‚úÖ ${endpoint.name}: Working!`, 'success');
                        
                        // Show key metrics
                        if (endpoint.name === 'Users Analytics' && data.data) {
                            addResult(`üë• Total Users: ${data.data.totalUsers || 0}`, 'info');
                        }
                        if (endpoint.name === 'Documents Analytics' && data.data) {
                            addResult(`üìÑ Total Documents: ${data.data.totalDocuments || 0}`, 'info');
                        }
                        if (endpoint.name === 'Downloads Analytics' && data.data) {
                            addResult(`‚¨áÔ∏è Total Downloads: ${data.data.totalDownloads || 0}`, 'info');
                        }
                        if (endpoint.name === 'System Analytics' && data.data) {
                            addResult(`‚ö° System Status: ${data.data.systemStatus || 'unknown'}`, 'info');
                        }
                    } else {
                        const errorText = await response.text();
                        addResult(`‚ùå ${endpoint.name}: Failed (${response.status})`, 'error');
                        addResult(`<pre>${errorText}</pre>`, 'error');
                    }
                } catch (error) {
                    addResult(`‚ùå ${endpoint.name}: Network error - ${error.message}`, 'error');
                }
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            addResult('üéâ API testing complete! If all tests passed, your admin dashboard should work.', 'success');
        }

        function goToAdmin() {
            if (!adminToken) {
                adminToken = localStorage.getItem('admin-token');
                if (!adminToken) {
                    addResult('‚ùå No admin token found. Please create an admin session first.', 'error');
                    return;
                }
            }
            
            addResult('üöÄ Opening admin dashboard...', 'success');
            window.open('/admin', '_blank');
        }

        // Auto-load admin token if it exists
        window.onload = function() {
            const existingToken = localStorage.getItem('admin-token');
            if (existingToken) {
                adminToken = existingToken;
                addResult(`üîë Found existing admin token: ${existingToken.substring(0, 20)}...`, 'info');
            }
        };
    </script>
</body>
</html>