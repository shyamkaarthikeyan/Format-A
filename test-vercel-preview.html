<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel Preview Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Vercel Preview Compatibility Test</h1>
    
    <div class="test-section info">
        <h3>Environment Detection</h3>
        <p>Current environment: <span id="environment">Detecting...</span></p>
        <p>Hostname: <span id="hostname"></span></p>
        <p>PDF Support: <span id="pdf-support"></span></p>
    </div>

    <div class="test-section">
        <h3>API Endpoint Tests</h3>
        <button onclick="testHealthEndpoint()">Test Health API</button>
        <button onclick="testDocxEndpoint()">Test DOCX API</button>
        <button onclick="testPdfEndpoint()">Test PDF API</button>
        <div id="api-results"></div>
    </div>

    <div class="test-section">
        <h3>Frontend Integration Test</h3>
        <button onclick="testFrontendIntegration()">Test Document Preview</button>
        <div id="frontend-results"></div>
    </div>

    <script>
        // Environment detection
        function detectEnvironment() {
            const isVercel = !!(
                window.location.hostname.includes('vercel.app') ||
                window.location.hostname.includes('vercel.live') ||
                window.location.hostname.match(/^[a-z0-9-]+-[a-z0-9-]+-[a-z0-9]+\.vercel\.app$/)
            );
            
            const isLocal = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1' ||
                           window.location.port === '3000' ||
                           window.location.port === '5173';
            
            return {
                isVercel,
                isLocal,
                supportsPdfGeneration: !isVercel
            };
        }

        // Update environment info
        const env = detectEnvironment();
        document.getElementById('environment').textContent = env.isVercel ? 'Vercel' : env.isLocal ? 'Local' : 'Other';
        document.getElementById('hostname').textContent = window.location.hostname;
        document.getElementById('pdf-support').textContent = env.supportsPdfGeneration ? 'Yes' : 'No (Expected on Vercel)';

        // API Tests
        async function testHealthEndpoint() {
            try {
                const response = await fetch('/api/health');
                const result = await response.text();
                showResult('api-results', 'Health API', response.ok, result);
            } catch (error) {
                showResult('api-results', 'Health API', false, error.message);
            }
        }

        async function testDocxEndpoint() {
            try {
                const testDoc = {
                    title: "Test Document",
                    authors: [{ name: "Test Author", affiliation: "Test University" }],
                    abstract: "Test abstract",
                    sections: [{ title: "Introduction", content: "Test content" }]
                };

                const response = await fetch('/api/generate/docx', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testDoc)
                });

                const result = await response.json();
                showResult('api-results', 'DOCX API', response.status === 503, JSON.stringify(result, null, 2));
            } catch (error) {
                showResult('api-results', 'DOCX API', false, error.message);
            }
        }

        async function testPdfEndpoint() {
            try {
                const testDoc = {
                    title: "Test Document",
                    authors: [{ name: "Test Author", affiliation: "Test University" }],
                    abstract: "Test abstract",
                    sections: [{ title: "Introduction", content: "Test content" }]
                };

                const response = await fetch('/api/generate/docx-to-pdf?preview=true', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Preview': 'true'
                    },
                    body: JSON.stringify(testDoc)
                });

                const result = await response.json();
                const expectedStatus = env.isVercel ? 503 : 200;
                showResult('api-results', 'PDF API', response.status === expectedStatus, JSON.stringify(result, null, 2));
            } catch (error) {
                showResult('api-results', 'PDF API', false, error.message);
            }
        }

        async function testFrontendIntegration() {
            const results = [];
            
            // Test if React app loads
            try {
                const response = await fetch('/');
                results.push(`Frontend loads: ${response.ok ? 'Yes' : 'No'}`);
            } catch (error) {
                results.push(`Frontend loads: Error - ${error.message}`);
            }

            // Test if assets are accessible
            try {
                const response = await fetch('/assets/');
                results.push(`Assets accessible: ${response.status !== 404 ? 'Yes' : 'No'}`);
            } catch (error) {
                results.push(`Assets accessible: Unknown`);
            }

            showResult('frontend-results', 'Frontend Integration', true, results.join('\n'));
        }

        function showResult(containerId, testName, success, details) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-section ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <h4>${testName}: ${success ? 'PASS' : 'FAIL'}</h4>
                <pre>${details}</pre>
            `;
            container.appendChild(resultDiv);
        }

        // Auto-run environment detection on load
        console.log('Environment detected:', env);
    </script>
</body>
</html>