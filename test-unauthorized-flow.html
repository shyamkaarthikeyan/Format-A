<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Unauthorized Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .auth-button { background: #28a745; }
        .auth-button:hover { background: #1e7e34; }
        .danger-button { background: #dc3545; }
        .danger-button:hover { background: #c82333; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .status { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .status.authenticated { background: #28a745; color: white; }
        .status.unauthenticated { background: #dc3545; color: white; }
        .status.admin { background: #007bff; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Authentication Flow Test</h1>
        
        <div class="section info">
            <h3>Current Status</h3>
            <div id="authStatus">Loading...</div>
        </div>
        
        <div class="section">
            <h3>üß™ Test Actions</h3>
            <div style="margin-bottom: 15px;">
                <button onclick="testDownloadFlow()" id="downloadBtn">Test Download (Should be restricted)</button>
                <button onclick="testAdminAccess()" id="adminBtn">Test Admin Access</button>
                <button onclick="testAuthVerify()" id="verifyBtn">Test Auth Verify</button>
            </div>
            <div>
                <button class="auth-button" onclick="simulateLogin()">Simulate Login</button>
                <button class="auth-button" onclick="simulateAdminLogin()">Simulate Admin Login</button>
                <button class="danger-button" onclick="clearAuth()">Clear Auth</button>
            </div>
        </div>
        
        <div class="section">
            <h3>üìä Test Results</h3>
            <div id="testResults"></div>
        </div>
        
        <div class="section">
            <h3>üîç Debug Info</h3>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let isAuthenticated = false;
        let isAdmin = false;
        
        // Update status display
        function updateStatus() {
            const statusDiv = document.getElementById('authStatus');
            const user = localStorage.getItem('format-a-user');
            const adminSession = localStorage.getItem('admin-session');
            
            let statusHTML = '';
            
            if (user) {
                const userData = JSON.parse(user);
                currentUser = userData;
                isAuthenticated = true;
                isAdmin = userData.email === 'shyamkaarthikeyan@gmail.com';
                
                statusHTML += `<span class="status authenticated">AUTHENTICATED</span> `;
                statusHTML += `User: ${userData.name || userData.email}<br>`;
                
                if (isAdmin) {
                    statusHTML += `<span class="status admin">ADMIN</span> `;
                    statusHTML += `Admin Session: ${adminSession ? '‚úÖ Active' : '‚ùå Missing'}<br>`;
                }
            } else {
                currentUser = null;
                isAuthenticated = false;
                isAdmin = false;
                statusHTML += `<span class="status unauthenticated">UNAUTHENTICATED</span><br>`;
            }
            
            statusDiv.innerHTML = statusHTML;
            
            // Update button states
            const downloadBtn = document.getElementById('downloadBtn');
            const adminBtn = document.getElementById('adminBtn');
            
            downloadBtn.disabled = !isAuthenticated;
            downloadBtn.textContent = isAuthenticated ? 'Test Download (Should work)' : 'Test Download (Should be restricted)';
            
            adminBtn.disabled = !isAdmin;
            adminBtn.textContent = isAdmin ? 'Test Admin Access (Should work)' : 'Test Admin Access (Should be restricted)';
        }
        
        // Test download flow
        async function testDownloadFlow() {
            addResult('üîΩ Testing Download Flow...', 'info');
            
            if (!isAuthenticated) {
                addResult('‚ùå Download blocked - User not authenticated (CORRECT)', 'success');
                return;
            }
            
            try {
                // Test document generation
                const testDoc = {
                    title: 'Test Document',
                    authors: [{ name: 'Test Author', affiliation: 'Test Org' }],
                    sections: [{ title: 'Introduction', content: 'This is a test document.' }],
                    abstract: 'Test abstract',
                    keywords: ['test'],
                    references: [],
                    figures: [],
                    settings: { fontSize: '10pt', columns: '2', exportFormat: 'docx' }
                };
                
                const response = await fetch('/api/generate/docx', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(testDoc)
                });
                
                if (response.ok) {
                    addResult('‚úÖ Download successful - User authenticated (CORRECT)', 'success');
                } else {
                    const error = await response.text();
                    addResult(`‚ùå Download failed: ${response.status} - ${error}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå Download error: ${error.message}`, 'error');
            }
        }
        
        // Test admin access
        async function testAdminAccess() {
            addResult('üëë Testing Admin Access...', 'info');
            
            if (!isAdmin) {
                addResult('‚ùå Admin access blocked - User not admin (CORRECT)', 'success');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/analytics/users', {
                    credentials: 'include',
                    headers: {
                        'X-Admin-Token': localStorage.getItem('admin-token') || ''
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult('‚úÖ Admin access successful (CORRECT)', 'success');
                    addResult(`üìä Found ${data.data?.totalUsers || 0} users`, 'info');
                } else {
                    const error = await response.text();
                    addResult(`‚ùå Admin access failed: ${response.status} - ${error}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå Admin access error: ${error.message}`, 'error');
            }
        }
        
        // Test auth verify
        async function testAuthVerify() {
            addResult('üîç Testing Auth Verify...', 'info');
            
            try {
                const response = await fetch('/api/auth/verify', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    addResult('‚úÖ Auth verify successful', 'success');
                    addResult(`User: ${data.user.name || data.user.email}`, 'info');
                } else {
                    addResult(`‚ùå Auth verify failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå Auth verify error: ${error.message}`, 'error');
            }
        }
        
        // Simulate login
        function simulateLogin() {
            const user = {
                id: 'user_' + Date.now(),
                email: 'test@example.com',
                name: 'Test User',
                picture: null,
                isActive: true,
                preferences: {}
            };
            
            localStorage.setItem('format-a-user', JSON.stringify(user));
            document.cookie = `sessionId=session_${Date.now()}; path=/; max-age=86400`;
            
            addResult('‚úÖ Simulated regular user login', 'success');
            updateStatus();
        }
        
        // Simulate admin login
        function simulateAdminLogin() {
            const adminUser = {
                id: 'admin_' + Date.now(),
                email: 'shyamkaarthikeyan@gmail.com',
                name: 'Admin User',
                picture: null,
                isActive: true,
                preferences: {}
            };
            
            const adminSession = {
                sessionId: 'admin_session_' + Date.now(),
                userId: adminUser.id,
                adminPermissions: [
                    'view_analytics',
                    'manage_users', 
                    'system_monitoring',
                    'download_reports',
                    'admin_panel_access'
                ],
                createdAt: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                lastAccessedAt: new Date().toISOString()
            };
            
            const adminToken = 'admin_token_' + Date.now();
            
            localStorage.setItem('format-a-user', JSON.stringify(adminUser));
            localStorage.setItem('admin-session', JSON.stringify(adminSession));
            localStorage.setItem('admin-token', adminToken);
            document.cookie = `sessionId=session_${Date.now()}; path=/; max-age=86400`;
            
            addResult('‚úÖ Simulated admin user login', 'success');
            updateStatus();
        }
        
        // Clear auth
        function clearAuth() {
            localStorage.removeItem('format-a-user');
            localStorage.removeItem('admin-session');
            localStorage.removeItem('admin-token');
            document.cookie = 'sessionId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            addResult('üßπ Cleared all authentication data', 'warning');
            updateStatus();
        }
        
        // Add result to display
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const resultHTML = `<div class="${type}">[${timestamp}] ${message}</div>`;
            resultsDiv.innerHTML = resultHTML + resultsDiv.innerHTML;
        }
        
        // Update debug info
        function updateDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            const user = localStorage.getItem('format-a-user');
            const adminSession = localStorage.getItem('admin-session');
            const adminToken = localStorage.getItem('admin-token');
            const cookies = document.cookie;
            
            let debugHTML = '<h4>Local Storage:</h4>';
            debugHTML += `<pre>User: ${user || 'None'}</pre>`;
            debugHTML += `<pre>Admin Session: ${adminSession || 'None'}</pre>`;
            debugHTML += `<pre>Admin Token: ${adminToken || 'None'}</pre>`;
            debugHTML += '<h4>Cookies:</h4>';
            debugHTML += `<pre>${cookies || 'None'}</pre>`;
            
            debugDiv.innerHTML = debugHTML;
        }
        
        // Initialize
        updateStatus();
        updateDebugInfo();
        
        // Update debug info every 2 seconds
        setInterval(() => {
            updateDebugInfo();
        }, 2000);
        
        addResult('üöÄ Test page loaded - Ready for testing', 'info');
    </script>
</body>
</html>