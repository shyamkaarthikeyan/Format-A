<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Authentication Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .success { background-color: #d4edda; border-left: 4px solid #28a745; }
        .error { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .warning { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .info { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        button { padding: 12px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .status-item { padding: 15px; border-radius: 5px; text-align: center; }
        .status-ok { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .step { margin: 15px 0; padding: 15px; border-left: 3px solid #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üîß Complete Authentication & Preview Fix</h1>
            <p>This tool will fix both authentication issues and PDF preview problems.</p>
        </div>

        <div class="card info">
            <h3>üéØ Current Issues Detected</h3>
            <ul>
                <li>‚úÖ User is authenticated but missing session cookie</li>
                <li>‚ùå Downloads showing "unauthorized" despite being logged in</li>
                <li>‚ùå PDF preview not generating</li>
                <li>‚ùå Admin session missing for admin panel</li>
            </ul>
        </div>

        <div class="card">
            <h3>üìä Current Authentication Status</h3>
            <div class="status-grid" id="authStatus">
                <div class="status-item status-error">Loading...</div>
            </div>
        </div>

        <div class="card">
            <h3>üöÄ Quick Fix Actions</h3>
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn-success" onclick="applyCompleteFix()">
                    üîß Apply Complete Fix
                </button>
                <button class="btn-primary" onclick="testEverything()">
                    üß™ Test All Functions
                </button>
                <button class="btn-warning" onclick="checkStatus()">
                    üìä Check Status
                </button>
                <button class="btn-danger" onclick="resetEverything()">
                    üóëÔ∏è Reset All
                </button>
            </div>
        </div>

        <div class="card">
            <h3>üìã Step-by-Step Fix</h3>
            <div class="step">
                <h4>Step 1: Create Session Cookie</h4>
                <button class="btn-primary" onclick="createSessionCookie()">Create Session Cookie</button>
                <p>Creates the missing sessionId cookie needed for API authentication.</p>
            </div>
            
            <div class="step">
                <h4>Step 2: Create Admin Session</h4>
                <button class="btn-primary" onclick="createAdminSession()">Create Admin Session</button>
                <p>Creates admin session and token for admin panel access.</p>
            </div>
            
            <div class="step">
                <h4>Step 3: Test Preview Generation</h4>
                <button class="btn-primary" onclick="testPreviewGeneration()">Test Preview</button>
                <p>Tests PDF preview generation with authentication.</p>
            </div>
            
            <div class="step">
                <h4>Step 4: Test Downloads</h4>
                <button class="btn-primary" onclick="testDownloads()">Test Downloads</button>
                <p>Tests both DOCX and PDF download functionality.</p>
            </div>
        </div>

        <div class="card">
            <h3>üìä Test Results</h3>
            <div id="results"></div>
        </div>

        <div class="card">
            <h3>üîç Debug Information</h3>
            <details>
                <summary>Click to view raw debug data</summary>
                <pre id="debugData">Click "Check Status" to load debug data</pre>
            </details>
        </div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            const resultHTML = `<div class="card ${className}">[${timestamp}] ${message}</div>`;
            resultsDiv.innerHTML = resultHTML + resultsDiv.innerHTML;
        }

        function checkStatus() {
            const user = localStorage.getItem('format-a-user');
            const adminSession = localStorage.getItem('admin-session');
            const adminToken = localStorage.getItem('admin-token');
            const cookies = document.cookie;
            
            const hasUser = !!user;
            const hasAdminSession = !!adminSession;
            const hasAdminToken = !!adminToken;
            const hasSessionCookie = cookies.includes('sessionId');
            
            let statusHTML = '';
            statusHTML += `<div class="status-item ${hasUser ? 'status-ok' : 'status-error'}">User Data: ${hasUser ? 'EXISTS' : 'MISSING'}</div>`;
            statusHTML += `<div class="status-item ${hasSessionCookie ? 'status-ok' : 'status-error'}">Session Cookie: ${hasSessionCookie ? 'EXISTS' : 'MISSING'}</div>`;
            statusHTML += `<div class="status-item ${hasAdminSession ? 'status-ok' : 'status-error'}">Admin Session: ${hasAdminSession ? 'EXISTS' : 'MISSING'}</div>`;
            statusHTML += `<div class="status-item ${hasAdminToken ? 'status-ok' : 'status-error'}">Admin Token: ${hasAdminToken ? 'EXISTS' : 'MISSING'}</div>`;
            
            document.getElementById('authStatus').innerHTML = statusHTML;
            
            // Update debug data
            const debugData = {
                user: user ? JSON.parse(user) : null,
                adminSession: adminSession ? JSON.parse(adminSession) : null,
                adminToken: adminToken,
                cookies: cookies,
                timestamp: new Date().toISOString()
            };
            
            document.getElementById('debugData').textContent = JSON.stringify(debugData, null, 2);
            
            addResult('Status check completed', 'info');
        }

        function createSessionCookie() {
            const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            document.cookie = `sessionId=${sessionId}; path=/; max-age=86400; SameSite=Lax; Secure=false`;
            addResult('‚úÖ Session cookie created: ' + sessionId, 'success');
            checkStatus();
        }

        function createAdminSession() {
            const adminSession = {
                sessionId: 'admin_session_' + Date.now(),
                userId: 'admin_user_' + Date.now(),
                adminPermissions: [
                    'view_analytics',
                    'manage_users', 
                    'system_monitoring',
                    'download_reports',
                    'admin_panel_access'
                ],
                createdAt: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                lastAccessedAt: new Date().toISOString()
            };

            const adminToken = 'admin_token_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            localStorage.setItem('admin-session', JSON.stringify(adminSession));
            localStorage.setItem('admin-token', adminToken);

            addResult('‚úÖ Admin session and token created', 'success');
            checkStatus();
        }

        async function testPreviewGeneration() {
            addResult('üß™ Testing PDF preview generation...', 'info');
            
            const testDoc = {
                title: 'Test Document for Preview',
                authors: [{ name: 'Test Author', affiliation: 'Test Organization' }],
                sections: [{ title: 'Introduction', content: 'This is a test document to verify PDF preview generation works correctly with authentication.' }],
                abstract: 'This is a test abstract for preview generation testing.',
                keywords: ['test', 'preview', 'authentication'],
                references: [],
                figures: [],
                settings: { 
                    fontSize: '10pt', 
                    columns: '2', 
                    exportFormat: 'docx',
                    includePageNumbers: true,
                    includeCopyright: false
                }
            };

            try {
                const response = await fetch('/api/generate/docx-to-pdf', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getCookie('sessionId')}`
                    },
                    credentials: 'include',
                    body: JSON.stringify(testDoc)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    if (blob.size > 0) {
                        addResult('‚úÖ PDF preview generation successful! Size: ' + (blob.size / 1024).toFixed(1) + ' KB', 'success');
                        
                        // Create a preview URL to verify it works
                        const url = URL.createObjectURL(blob);
                        addResult('üìÑ Preview URL created - PDF generation is working!', 'success');
                        URL.revokeObjectURL(url);
                    } else {
                        addResult('‚ùå PDF generated but file is empty', 'error');
                    }
                } else {
                    const errorText = await response.text();
                    addResult(`‚ùå Preview generation failed: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå Preview generation error: ${error.message}`, 'error');
            }
        }

        async function testDownloads() {
            addResult('üß™ Testing download functionality...', 'info');
            
            const testDoc = {
                title: 'Test Download Document',
                authors: [{ name: 'Download Test Author', affiliation: 'Test Org' }],
                sections: [{ title: 'Test Section', content: 'Testing download functionality.' }],
                abstract: 'Test abstract for download',
                keywords: ['test', 'download'],
                references: [],
                figures: [],
                settings: { fontSize: '10pt', columns: '2', exportFormat: 'docx' }
            };

            // Test DOCX download
            try {
                const docxResponse = await fetch('/api/generate/docx', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getCookie('sessionId')}`
                    },
                    credentials: 'include',
                    body: JSON.stringify(testDoc)
                });

                if (docxResponse.ok) {
                    const blob = await docxResponse.blob();
                    addResult(`‚úÖ DOCX download test successful! Size: ${(blob.size / 1024).toFixed(1)} KB`, 'success');
                } else {
                    const errorText = await docxResponse.text();
                    addResult(`‚ùå DOCX download failed: ${docxResponse.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå DOCX download error: ${error.message}`, 'error');
            }

            // Test PDF download
            try {
                const pdfResponse = await fetch('/api/generate/docx-to-pdf', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getCookie('sessionId')}`
                    },
                    credentials: 'include',
                    body: JSON.stringify(testDoc)
                });

                if (pdfResponse.ok) {
                    const blob = await pdfResponse.blob();
                    addResult(`‚úÖ PDF download test successful! Size: ${(blob.size / 1024).toFixed(1)} KB`, 'success');
                } else {
                    const errorText = await pdfResponse.text();
                    addResult(`‚ùå PDF download failed: ${pdfResponse.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå PDF download error: ${error.message}`, 'error');
            }
        }

        async function testEverything() {
            addResult('üöÄ Running complete test suite...', 'info');
            checkStatus();
            await testPreviewGeneration();
            await testDownloads();
            addResult('‚úÖ Complete test suite finished!', 'success');
        }

        function applyCompleteFix() {
            addResult('üîß Applying complete authentication fix...', 'info');
            
            // Ensure user data exists
            let user = localStorage.getItem('format-a-user');
            if (!user) {
                user = {
                    id: 'user_' + Date.now(),
                    email: 'shyamkaarthikeyan@gmail.com',
                    name: 'Shyam Kaarthikeyan',
                    picture: null,
                    isActive: true,
                    preferences: {},
                    createdAt: new Date().toISOString(),
                    lastLoginAt: new Date().toISOString()
                };
                localStorage.setItem('format-a-user', JSON.stringify(user));
                addResult('‚úÖ User data created', 'success');
            } else {
                addResult('‚úÖ User data already exists', 'success');
            }

            // Create session cookie
            createSessionCookie();
            
            // Create admin session
            createAdminSession();
            
            addResult('üéâ Complete fix applied! Refreshing page in 2 seconds...', 'success');
            
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        function resetEverything() {
            if (confirm('This will clear all authentication data. Are you sure?')) {
                localStorage.removeItem('format-a-user');
                localStorage.removeItem('admin-session');
                localStorage.removeItem('admin-token');
                document.cookie = 'sessionId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                
                addResult('üóëÔ∏è All authentication data cleared', 'warning');
                checkStatus();
            }
        }

        function getCookie(name) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [cookieName, cookieValue] = cookie.trim().split('=');
                if (cookieName === name) {
                    return cookieValue;
                }
            }
            return null;
        }

        // Initialize
        checkStatus();
        addResult('üéØ Authentication fix tool loaded. Click "Apply Complete Fix" to resolve all issues.', 'info');
    </script>
</body>
</html>