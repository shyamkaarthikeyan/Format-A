<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Admin API - Final Check</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 200px; }
        .summary { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>Admin API Final Test</h1>
    <p>Testing the fixed admin endpoints to verify they work correctly.</p>
    
    <div class="summary">
        <h3>üéØ Expected Results:</h3>
        <ul>
            <li><strong>User Management:</strong> Should show 7 users with proper formatting</li>
            <li><strong>Document Analytics:</strong> Should show 77 documents with trends and metrics</li>
            <li><strong>All Other Analytics:</strong> Should work as before</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h3>User Management Test (Fixed)</h3>
        <button onclick="testUserManagement()">Test User Management</button>
        <div id="user-management-result"></div>
    </div>

    <div class="test-section">
        <h3>Document Analytics Test (Check Empty Arrays)</h3>
        <button onclick="testDocumentAnalytics()">Test Document Analytics</button>
        <div id="document-analytics-result"></div>
    </div>

    <div class="test-section">
        <h3>All Analytics Summary</h3>
        <button onclick="testAllAnalytics()">Test All Analytics</button>
        <div id="all-analytics-result"></div>
    </div>

    <script>
        async function makeAdminRequest(endpoint) {
            const adminToken = localStorage.getItem('admin-token') || 'admin_token_test';
            
            const url = `/api/admin?path=${endpoint}`;
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Token': adminToken
                }
            });
            
            const data = await response.text();
            let jsonData;
            try {
                jsonData = JSON.parse(data);
            } catch (e) {
                jsonData = { error: 'Invalid JSON response', rawResponse: data };
            }
            
            return {
                status: response.status,
                success: response.ok && jsonData.success !== false,
                data: jsonData
            };
        }

        async function testUserManagement() {
            const resultDiv = document.getElementById('user-management-result');
            resultDiv.innerHTML = '<div class="warning">Testing User Management...</div>';
            
            try {
                const result = await makeAdminRequest('users');
                
                if (result.success) {
                    const data = result.data.data || result.data;
                    
                    // Check if it's raw array or formatted object
                    let userCount = 0;
                    let dataType = '';
                    let hasFormattedFields = false;
                    
                    if (Array.isArray(data)) {
                        userCount = data.length;
                        dataType = 'Raw Array';
                        hasFormattedFields = data[0] && data[0].createdAt && !data[0].google_id;
                    } else if (data.users) {
                        userCount = data.users.length;
                        dataType = 'Formatted Object';
                        hasFormattedFields = data.users[0] && data.users[0].createdAt && !data.users[0].google_id;
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ User Management Working!</h4>
                            <p><strong>Data Type:</strong> ${dataType}</p>
                            <p><strong>User Count:</strong> ${userCount}</p>
                            <p><strong>Has Formatted Fields:</strong> ${hasFormattedFields ? 'Yes' : 'No (Raw DB fields)'}</p>
                            <p><strong>Component Compatibility:</strong> ${hasFormattedFields || Array.isArray(data) ? '‚úÖ Compatible' : '‚ö†Ô∏è May need formatting'}</p>
                            ${data.summary ? `<p><strong>Summary:</strong> ${data.summary.totalUsers} total, ${data.summary.activeUsers} active</p>` : ''}
                            <details>
                                <summary>Sample User Data</summary>
                                <pre>${JSON.stringify(Array.isArray(data) ? data[0] : data.users?.[0] || data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå User Management Failed</h4>
                            <p><strong>Status:</strong> ${result.status}</p>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error Testing User Management</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testDocumentAnalytics() {
            const resultDiv = document.getElementById('document-analytics-result');
            resultDiv.innerHTML = '<div class="warning">Testing Document Analytics...</div>';
            
            try {
                const result = await makeAdminRequest('analytics&type=documents');
                
                if (result.success) {
                    const data = result.data.data || result.data;
                    
                    // Check for empty arrays that might cause rendering issues
                    const emptyArrays = [];
                    if (data.popularTopics && data.popularTopics.length === 0) emptyArrays.push('popularTopics');
                    if (data.documentTrends?.daily && data.documentTrends.daily.length === 0) emptyArrays.push('daily trends');
                    if (data.documentDistribution?.byUser && data.documentDistribution.byUser.length === 0) emptyArrays.push('user distribution');
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Document Analytics Working!</h4>
                            <p><strong>Total Documents:</strong> ${data.totalDocuments}</p>
                            <p><strong>Documents This Month:</strong> ${data.documentsThisMonth}</p>
                            <p><strong>Recent Documents:</strong> ${data.recentDocuments?.length || 0}</p>
                            <p><strong>Growth Rate:</strong> ${data.growthRate}%</p>
                            ${emptyArrays.length > 0 ? 
                                `<p><strong>‚ö†Ô∏è Empty Arrays:</strong> ${emptyArrays.join(', ')} (may cause blank sections)</p>` : 
                                '<p><strong>‚úÖ All Arrays:</strong> Have data</p>'
                            }
                            <details>
                                <summary>Data Structure</summary>
                                <pre>${JSON.stringify({
                                    totalDocuments: data.totalDocuments,
                                    documentsThisMonth: data.documentsThisMonth,
                                    recentDocumentsCount: data.recentDocuments?.length,
                                    popularTopicsCount: data.popularTopics?.length,
                                    dailyTrendsCount: data.documentTrends?.daily?.length,
                                    userDistributionCount: data.documentDistribution?.byUser?.length
                                }, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Document Analytics Failed</h4>
                            <p><strong>Status:</strong> ${result.status}</p>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error Testing Document Analytics</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testAllAnalytics() {
            const resultDiv = document.getElementById('all-analytics-result');
            resultDiv.innerHTML = '<div class="warning">Testing All Analytics...</div>';
            
            const endpoints = [
                { path: 'analytics&type=users', name: 'User Analytics' },
                { path: 'analytics&type=documents', name: 'Document Analytics' },
                { path: 'analytics&type=downloads', name: 'Download Analytics' },
                { path: 'analytics&type=system', name: 'System Health' },
                { path: 'users', name: 'User Management' }
            ];
            
            let results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const result = await makeAdminRequest(endpoint.path);
                    results.push({
                        name: endpoint.name,
                        status: result.success ? '‚úÖ Working' : '‚ùå Failed',
                        details: result.success ? 'OK' : result.data.error || 'Unknown error'
                    });
                } catch (error) {
                    results.push({
                        name: endpoint.name,
                        status: '‚ùå Error',
                        details: error.message
                    });
                }
            }
            
            const allWorking = results.every(r => r.status.includes('‚úÖ'));
            
            resultDiv.innerHTML = `
                <div class="${allWorking ? 'success' : 'warning'}">
                    <h4>${allWorking ? 'üéâ All Analytics Working!' : '‚ö†Ô∏è Some Issues Found'}</h4>
                    <ul>
                        ${results.map(r => `<li><strong>${r.name}:</strong> ${r.status} ${r.details !== 'OK' ? `(${r.details})` : ''}</li>`).join('')}
                    </ul>
                    ${allWorking ? '<p><strong>üöÄ Your admin dashboard should now be fully functional!</strong></p>' : ''}
                </div>
            `;
        }

        // Auto-setup admin token
        if (!localStorage.getItem('admin-token')) {
            localStorage.setItem('admin-token', 'admin_token_test');
        }
    </script>
</body>
</html>