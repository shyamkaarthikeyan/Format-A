<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Admin Authentication</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #6d28d9;
        }
        .button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        .log {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .token-display {
            background: #f9fafb;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Admin Authentication Debugger</h1>
        <p>This tool helps debug admin authentication issues on Vercel.</p>

        <div class="section">
            <h2>1. Current Authentication Status</h2>
            <div id="auth-status"></div>
            <button class="button" onclick="checkAuthStatus()">Check Status</button>
            <button class="button" onclick="clearAuth()">Clear All Auth Data</button>
        </div>

        <div class="section">
            <h2>2. Create Admin Session</h2>
            <p>Create a new admin session for testing:</p>
            <input type="email" id="admin-email" placeholder="Enter admin email" value="shyamkaarthikeyan@gmail.com" style="padding: 8px; margin: 10px 0; width: 300px;">
            <br>
            <button class="button" onclick="createAdminSession()">Create Admin Session</button>
            <button class="button" onclick="createLocalSession()">Create Local Session (Fallback)</button>
        </div>

        <div class="section">
            <h2>3. Test Admin API Endpoints</h2>
            <p>Test individual admin API endpoints:</p>
            <button class="button" onclick="testEndpoint('users')">Test Users API</button>
            <button class="button" onclick="testEndpoint('documents')">Test Documents API</button>
            <button class="button" onclick="testEndpoint('downloads')">Test Downloads API</button>
            <button class="button" onclick="testEndpoint('system')">Test System API</button>
        </div>

        <div class="section">
            <h2>4. Debug Information</h2>
            <div id="debug-info"></div>
            <button class="button" onclick="showDebugInfo()">Show Debug Info</button>
        </div>

        <div class="section">
            <h2>5. Activity Log</h2>
            <div id="log" class="log"></div>
            <button class="button" onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        let logContent = '';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logContent += logEntry;
            document.getElementById('log').textContent = logContent;
            console.log(logEntry);
        }

        function clearLog() {
            logContent = '';
            document.getElementById('log').textContent = '';
        }

        function checkAuthStatus() {
            log('Checking authentication status...');
            
            const adminToken = localStorage.getItem('admin-token');
            const adminSession = localStorage.getItem('admin-session');
            
            let status = '<div class="info">';
            status += '<h3>Authentication Status:</h3>';
            status += `<p><strong>Admin Token:</strong> ${adminToken ? '‚úÖ Present' : '‚ùå Missing'}</p>`;
            status += `<p><strong>Admin Session:</strong> ${adminSession ? '‚úÖ Present' : '‚ùå Missing'}</p>`;
            
            if (adminToken) {
                status += `<div class="token-display"><strong>Token:</strong> ${adminToken}</div>`;
            }
            
            if (adminSession) {
                try {
                    const session = JSON.parse(adminSession);
                    status += `<div class="token-display"><strong>Session:</strong> ${JSON.stringify(session, null, 2)}</div>`;
                } catch (e) {
                    status += `<p class="error">Session data is corrupted: ${e.message}</p>`;
                }
            }
            
            status += '</div>';
            document.getElementById('auth-status').innerHTML = status;
            
            log(`Auth check complete. Token: ${!!adminToken}, Session: ${!!adminSession}`);
        }

        function clearAuth() {
            log('Clearing all authentication data...');
            localStorage.removeItem('admin-token');
            localStorage.removeItem('admin-session');
            document.getElementById('auth-status').innerHTML = '<div class="success">All authentication data cleared.</div>';
            log('Authentication data cleared');
        }

        async function createAdminSession() {
            const email = document.getElementById('admin-email').value;
            if (!email) {
                log('Please enter an admin email', 'error');
                return;
            }

            log(`Creating admin session for ${email}...`);
            
            try {
                const response = await fetch('/api/admin/auth/session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: 'admin_user',
                        email: email
                    })
                });

                log(`Session API response: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('admin-session', JSON.stringify(data.adminSession));
                    localStorage.setItem('admin-token', data.adminToken);
                    
                    document.getElementById('auth-status').innerHTML = '<div class="success">‚úÖ Admin session created successfully via API!</div>';
                    log('Admin session created successfully via API');
                    checkAuthStatus();
                } else {
                    const errorText = await response.text();
                    log(`Session creation failed: ${response.status} - ${errorText}`, 'error');
                    document.getElementById('auth-status').innerHTML = `<div class="error">‚ùå Failed to create session: ${response.status} - ${errorText}</div>`;
                }
            } catch (error) {
                log(`Session creation error: ${error.message}`, 'error');
                document.getElementById('auth-status').innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }

        function createLocalSession() {
            log('Creating local admin session...');
            
            const localAdminSession = {
                sessionId: 'local_admin_' + Date.now(),
                userId: 'admin_user',
                adminPermissions: [
                    'view_analytics',
                    'manage_users',
                    'system_monitoring',
                    'download_reports',
                    'admin_panel_access'
                ],
                createdAt: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                lastAccessedAt: new Date().toISOString()
            };
            
            const adminToken = 'admin_token_' + Date.now();
            
            localStorage.setItem('admin-session', JSON.stringify(localAdminSession));
            localStorage.setItem('admin-token', adminToken);
            
            document.getElementById('auth-status').innerHTML = '<div class="success">‚úÖ Local admin session created successfully!</div>';
            log('Local admin session created successfully');
            checkAuthStatus();
        }

        async function testEndpoint(endpoint) {
            const adminToken = localStorage.getItem('admin-token');
            if (!adminToken) {
                log(`Cannot test ${endpoint} - no admin token`, 'error');
                return;
            }

            log(`Testing ${endpoint} endpoint...`);
            
            try {
                const response = await fetch(`/api/admin/analytics/${endpoint}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Token': adminToken
                    },
                    credentials: 'include'
                });

                log(`${endpoint} API response: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const data = await response.json();
                    log(`${endpoint} API success: ${JSON.stringify(data).substring(0, 200)}...`);
                    document.getElementById('debug-info').innerHTML = `<div class="success">‚úÖ ${endpoint} API working correctly!</div>`;
                } else {
                    const errorText = await response.text();
                    log(`${endpoint} API failed: ${response.status} - ${errorText}`, 'error');
                    document.getElementById('debug-info').innerHTML = `<div class="error">‚ùå ${endpoint} API failed: ${response.status} - ${errorText}</div>`;
                }
            } catch (error) {
                log(`${endpoint} API error: ${error.message}`, 'error');
                document.getElementById('debug-info').innerHTML = `<div class="error">‚ùå ${endpoint} API network error: ${error.message}</div>`;
            }
        }

        function showDebugInfo() {
            log('Gathering debug information...');
            
            const debugInfo = {
                userAgent: navigator.userAgent,
                currentUrl: window.location.href,
                localStorage: {
                    adminToken: localStorage.getItem('admin-token'),
                    adminSession: localStorage.getItem('admin-session')
                },
                cookies: document.cookie,
                timestamp: new Date().toISOString()
            };
            
            let html = '<div class="info">';
            html += '<h3>Debug Information:</h3>';
            html += `<div class="token-display">${JSON.stringify(debugInfo, null, 2)}</div>`;
            html += '</div>';
            
            document.getElementById('debug-info').innerHTML = html;
            log('Debug information displayed');
        }

        // Initialize
        window.onload = function() {
            log('Admin Authentication Debugger loaded');
            checkAuthStatus();
        };
    </script>
</body>
</html>